---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: docker.service
      mask: false
      enabled: true

    - name: docker-compose@.service
      contents: |-
        [Unit]
        Description=%i service with docker compose
        After=docker.service
        Requires=docker.service

        [Service]
        Type=simple
        User=%i
        Restart=always
        TimeoutStartSec=0
        WorkingDirectory=/etc/docker/compose/%i

        ExecStartPre=-/usr/local/bin/docker-compose pull
        ExecStartPre=-/usr/local/bin/docker-compose rm -v -f -s
        ExecStartPre=-/usr/bin/docker image prune -f

        ExecStart=/usr/local/bin/docker-compose up --force-recreate --remove-orphans

        ExecStop=/usr/local/bin/docker-compse down -v

        [Install]
        WantedBy=multi-user.target
        WantedBy=docker.service

storage:
  # paths fully specified
  # https://github.com/coreos/ignition/blob/9a7533ccf57156725e03ec239e5568de2d36f117/internal/exec/stages/files/filesystemEntries.go#L101
  directories:
    - path: /etc/docker
      mode: 0755
    - path: /etc/docker/compose
      mode: 0755

  files:
    - path: /usr/local/bin/docker-compose
      mode: 0755
      contents:
        remote:
          url: https://github.com/docker/compose/releases/download/1.29.2/docker-compose-linux-x86_64
